---
const { product, index } = Astro.props;

function hostname(url) {
  try {
    return new URL(url).hostname.replace(/^www\./, "");
  } catch {
    return "";
  }
}

const hasUrl = typeof product?.url === "string" && product.url.trim().length > 0;

// Option B fallback: build an Amazon search link when we don't have a real product URL yet.
const query =
  typeof product?.amazon_search_query === "string" && product.amazon_search_query.trim().length > 0
    ? product.amazon_search_query.trim()
    : typeof product?.title === "string"
      ? product.title.trim()
      : "";

const amazonSearchUrl = query
  ? `https://www.amazon.com/s?k=${encodeURIComponent(query)}`
  : "";

const ctaHref = hasUrl ? product.url : amazonSearchUrl;
const ctaLabel = hasUrl ? "Check price →" : "Search on Amazon →";

const site = hasUrl ? hostname(product.url) : "amazon.com";
const initials =
  (product?.title || "P")
    .trim()
    .split(/\s+/)
    .slice(0, 2)
    .map((w) => w[0]?.toUpperCase())
    .join("") || "P";

const ratingOk = typeof product?.rating === "number";
const reviewsOk = typeof product?.reviews_count === "number";
const priceOk = typeof product?.price === "string" && product.price.trim().length > 0;

const metaParts = [
  ratingOk ? `${product.rating.toFixed(1)}★` : null,
  reviewsOk ? `${product.reviews_count.toLocaleString()} reviews` : null,
  priceOk ? product.price : null,
].filter(Boolean);
const metaLine = metaParts.join(" · ");
---

<article class="pick-card">
  <div class="pick-row">
    <div class="pick-badge" aria-hidden="true">
      <div class="pick-badge-inner">
        <span class="pick-initials">{initials}</span>
      </div>
    </div>

    <div class="pick-main">
      <div class="pick-top">
        <div class="pick-head">
          <div class="pick-kicker">
            Pick {index} <span class="dot">•</span> {site}
            {!hasUrl && query ? <span class="ghost"> (search link)</span> : null}
          </div>

          <h3 class="pick-title">{product?.title}</h3>

          {metaLine ? <div class="pick-meta">{metaLine}</div> : null}
        </div>

        <div class="pick-cta">
          {ctaHref ? (
            <a
              href={ctaHref}
              target="_blank"
              rel="sponsored nofollow noopener"
              class={`btn ${hasUrl ? "btn-primary" : "btn-secondary"}`}
            >
              {ctaLabel}
            </a>
          ) : (
            <span class="btn btn-disabled" aria-disabled="true">
              Link coming soon
            </span>
          )}
        </div>
      </div>

      {product?.description ? (
        <p class="pick-desc">{product.description}</p>
      ) : null}
    </div>
  </div>
</article>

<style>
  .pick-card {
    background: rgba(255, 255, 255, 0.98);
    border: 1px solid rgba(17, 24, 39, 0.10);
    border-radius: 18px;
    padding: 16px;
    box-shadow: 0 1px 0 rgba(17, 24, 39, 0.03);
  }

  .pick-row {
    display: flex;
    gap: 14px;
    align-items: flex-start;
  }

  .pick-badge {
    width: 72px;
    height: 72px;
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(17, 24, 39, 0.10);
    background: rgba(17, 24, 39, 0.03);
    flex: 0 0 auto;
  }

  .pick-badge-inner {
    width: 100%;
    height: 100%;
    background: radial-gradient(
      80% 80% at 30% 20%,
      rgba(37, 99, 235, 0.18),
      rgba(17, 24, 39, 0.06)
    );
    display: grid;
    place-items: center;
  }

  .pick-initials {
    font-size: 13px;
    font-weight: 800;
    letter-spacing: 0.02em;
    color: rgba(17, 24, 39, 0.82);
  }

  .pick-main {
    min-width: 0;
    flex: 1 1 auto;
  }

  .pick-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 14px;
  }

  .pick-head {
    min-width: 0;
    flex: 1 1 auto;
  }

  .pick-kicker {
    font-size: 12px;
    color: rgba(55, 65, 81, 0.78);
    letter-spacing: 0.01em;
  }

  .dot {
    margin: 0 6px;
    opacity: 0.6;
  }

  .ghost {
    opacity: 0.85;
  }

  .pick-title {
    margin: 6px 0 0;
    font-size: 15px;
    line-height: 1.3;
    letter-spacing: -0.01em;
    color: rgba(17, 24, 39, 0.95);
    font-weight: 750;
  }

  .pick-meta {
    margin-top: 6px;
    font-size: 12px;
    color: rgba(55, 65, 81, 0.75);
  }

  .pick-cta {
    flex: 0 0 auto;
    display: grid;
    gap: 8px;
    justify-items: end;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 12px;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 750;
    text-decoration: none;
    user-select: none;
    white-space: nowrap;
    border: 1px solid transparent;
  }

  .btn-primary {
    background: rgb(37, 99, 235);
    color: #fff;
  }

  .btn-primary:hover {
    background: rgb(29, 78, 216);
  }

  .btn-secondary {
    background: rgba(17, 24, 39, 0.04);
    color: rgba(17, 24, 39, 0.88);
    border-color: rgba(17, 24, 39, 0.10);
  }

  .btn-secondary:hover {
    background: rgba(17, 24, 39, 0.06);
  }

  .btn-disabled {
    background: rgba(17, 24, 39, 0.03);
    color: rgba(55, 65, 81, 0.65);
    border-color: rgba(17, 24, 39, 0.08);
    cursor: not-allowed;
  }

  .pick-desc {
    margin: 10px 0 0;
    font-size: 14px;
    line-height: 1.65;
    color: rgba(17, 24, 39, 0.78);
  }

  @media (max-width: 520px) {
    .pick-top {
      flex-direction: column;
      align-items: stretch;
    }
    .pick-cta {
      justify-items: start;
    }
    .btn {
      width: 100%;
    }
  }
</style>
