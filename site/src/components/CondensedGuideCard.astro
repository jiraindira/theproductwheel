---
import type { CollectionEntry } from "astro:content";
import { groupForCategory, categoryLabel } from "../lib/taxonomy";
import { normalizePostCategories, primaryCategory } from "../lib/normalizeCategories";
import { getPostCardDescription } from "../lib/postExcerpt";

const { post, taxonomy } = Astro.props as {
  post: CollectionEntry<"posts">;
  taxonomy: any;
};

function formatDate(d: Date) {
  try {
    return new Date(d).toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    });
  } catch {
    return "";
  }
}

const categories = normalizePostCategories(post, taxonomy);
const primary = primaryCategory(post, taxonomy);
const g = groupForCategory(taxonomy, primary);

const desc = getPostCardDescription(post);
const shortDesc = typeof desc === "string" ? desc.trim() : "";
---

<a
  href={`/posts/${post.slug}`}
  class="group block rounded-2xl border border-gray-200 bg-white p-4 shadow-sm transition hover:border-gray-300 hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2"
>
  <div class="flex flex-wrap items-center gap-2">
    {g ? (
      <span class="inline-flex items-center rounded-full bg-gray-900 px-2.5 py-1 text-[11px] font-semibold text-white">
        {g.label}
      </span>
    ) : null}

    {categories.slice(0, 1).map((c) => (
      <span class="inline-flex items-center rounded-full border border-gray-200 bg-white px-2.5 py-1 text-[11px] font-semibold text-gray-700">
        {categoryLabel(taxonomy, c) || c}
      </span>
    ))}
  </div>

  <div class="mt-3">
    <h3 class="text-base font-semibold leading-snug text-gray-900 group-hover:text-gray-950">
      {post.data.title}
    </h3>

    {shortDesc ? (
      <p class="mt-2 text-sm leading-relaxed text-gray-700">
        {shortDesc}
      </p>
    ) : null}

    <div class="mt-3 text-xs font-semibold text-gray-600">
      {formatDate(post.data.publishedAt)}
    </div>
  </div>
</a>
