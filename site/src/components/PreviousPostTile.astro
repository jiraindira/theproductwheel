---
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import { getPostHeroImage } from "../lib/postImages";

const { post } = Astro.props as {
  post: CollectionEntry<"posts">;
};

const FALLBACK_HERO = "/images/placeholder-hero.webp";

function isAbsoluteUrl(v: string) {
  return /^https?:\/\//i.test(v);
}

function formatDate(d: Date) {
  try {
    return new Date(d).toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    });
  } catch {
    return "";
  }
}

const heroImageRaw = (() => {
  const preferred =
    typeof post?.data?.heroImageHome === "string" && post.data.heroImageHome.trim().length > 0
      ? post.data.heroImageHome.trim()
      : null;

  const fallback =
    typeof post?.data?.heroImage === "string" && post.data.heroImage.trim().length > 0
      ? post.data.heroImage.trim()
      : null;

  return preferred || fallback || FALLBACK_HERO;
})();

const isPublicHero = heroImageRaw.startsWith("/") || isAbsoluteUrl(heroImageRaw);
const heroAsset = !isPublicHero ? getPostHeroImage(heroImageRaw) : null;

const safeHeroAlt =
  typeof post?.data?.heroAlt === "string" && post.data.heroAlt.trim().length > 0
    ? post.data.heroAlt.trim()
    : post?.data?.title ?? "";

const WRAP_CLASS = "relative w-full overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm aspect-[4/5]";
const IMG_CLASS = "absolute inset-0 h-full w-full object-cover";
---

<a
  href={`/posts/${post.slug}`}
  class="group block focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2"
  aria-label={post.data.title}
>
  <div class={WRAP_CLASS}>
    {isPublicHero ? (
      <img src={heroImageRaw} alt={safeHeroAlt} class={IMG_CLASS} loading="lazy" decoding="async" />
    ) : heroAsset ? (
      <Image
        src={heroAsset}
        alt={safeHeroAlt}
        width={heroAsset.width}
        height={heroAsset.height}
        class={IMG_CLASS}
        sizes="(min-width: 1024px) 480px, 50vw"
        loading="lazy"
        decoding="async"
      />
    ) : (
      <img src={FALLBACK_HERO} alt={safeHeroAlt} class={IMG_CLASS} loading="lazy" decoding="async" />
    )}

    <div class="absolute inset-x-0 bottom-0">
      <div class="h-20 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
      <div class="absolute inset-x-0 bottom-0 p-3">
        <div class="text-[11px] font-semibold tracking-wide text-white/85">
          {formatDate(post.data.publishedAt)}
        </div>
        <h3 class="mt-1 text-sm font-semibold leading-snug text-white line-clamp-3">
          {post.data.title}
        </h3>
      </div>
    </div>
  </div>
</a>
