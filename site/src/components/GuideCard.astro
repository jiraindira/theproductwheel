---
import { Image } from "astro:assets";
import { getPostHeroImage } from "../lib/postImages";

const {
  href,
  title,
  description,
  category,
  publishedAt,
  products,
  heroImage,
  heroAlt,
} = Astro.props;

const FALLBACK_HERO = "/images/placeholder-hero.webp";

// Normalize hero image value
const heroImageRaw =
  typeof heroImage === "string" && heroImage.trim().length > 0
    ? heroImage.trim()
    : FALLBACK_HERO;

// Support both:
// - Public URLs: "/images/..." -> <img>
// - Asset paths: "src/assets/..." -> getPostHeroImage + <Image>
const isPublicHero = heroImageRaw.startsWith("/");
const heroAsset = !isPublicHero ? getPostHeroImage(heroImageRaw) : null;

const safeHeroAlt = (typeof heroAlt === "string" && heroAlt.trim().length > 0)
  ? heroAlt.trim()
  : title;

function formatDate(d) {
  try {
    return new Date(d).toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "long",
      year: "numeric",
    });
  } catch {
    return "";
  }
}

function daysAgoUTC(d) {
  const dt = new Date(d);
  const now = new Date();

  const utcA = Date.UTC(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate());
  const utcB = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());

  const days = Math.floor((utcB - utcA) / (1000 * 60 * 60 * 24));
  if (!isFinite(days) || days < 0) return null;
  return days;
}

function prettyCategory(s) {
  if (!s) return "";
  return s
    .replace(/_/g, " ")
    .replace(/\b\w/g, (c) => c.toUpperCase())
    .replace(/\bAnd\b/g, "&");
}

const publishedLabel = publishedAt ? formatDate(publishedAt) : null;

const ageDays = publishedAt ? daysAgoUTC(publishedAt) : null;
const freshnessLabel =
  ageDays === null
    ? null
    : ageDays === 0
      ? "Published today"
      : ageDays === 1
        ? "Published 1 day ago"
        : `Published ${ageDays} days ago`;

const categoryLabel = prettyCategory(category);

const topPick =
  Array.isArray(products) && products.length > 0 && products[0]?.title
    ? products[0].title
    : null;
---

<article class="group h-full rounded-2xl border border-gray-200 bg-white p-6 transition hover:-translate-y-0.5 hover:border-gray-300 hover:shadow-sm">
  <a href={href} class="block overflow-hidden rounded-xl border border-gray-200 bg-gray-50">
    {isPublicHero ? (
      <img
        src={heroImageRaw}
        alt={safeHeroAlt}
        class="h-40 w-full object-cover sm:h-44"
        loading="lazy"
        decoding="async"
      />
    ) : heroAsset ? (
      <Image
        src={heroAsset}
        alt={safeHeroAlt}
        width={heroAsset.width}
        height={heroAsset.height}
        class="h-40 w-full object-cover sm:h-44"
        sizes="(min-width: 1024px) 360px, (min-width: 640px) 45vw, 100vw"
        loading="lazy"
        decoding="async"
      />
    ) : (
      <img
        src={FALLBACK_HERO}
        alt={safeHeroAlt}
        class="h-40 w-full object-cover sm:h-44"
        loading="lazy"
        decoding="async"
      />
    )}
  </a>

  <div class="mt-4 flex items-center justify-between gap-3">
    <div class="text-xs text-gray-500">{publishedLabel}</div>

    {categoryLabel && (
      <span class="inline-flex items-center rounded-full border border-gray-200 bg-gray-50 px-2.5 py-1 text-xs text-gray-700">
        {categoryLabel}
      </span>
    )}
  </div>

  <h3 class="mt-3 text-lg font-semibold leading-snug tracking-tight text-gray-900">
    <a
      href={href}
      class="rounded-sm outline-none focus-visible:ring-2 focus-visible:ring-blue-500/40"
    >
      {title}
    </a>
  </h3>

  {description && (
    <p class="mt-2 text-sm leading-relaxed text-gray-600">
      {description}
    </p>
  )}

  {topPick && (
    <p class="mt-3 text-xs text-gray-500">
      <span class="font-medium text-gray-700">Top pick:</span> {topPick}
    </p>
  )}

  <div class="mt-5 flex items-center justify-between">
    <span class="text-sm font-medium text-blue-600 group-hover:text-blue-700">
      Read guide â†’
    </span>

    {freshnessLabel && <span class="text-xs text-gray-400">{freshnessLabel}</span>}
  </div>
</article>
