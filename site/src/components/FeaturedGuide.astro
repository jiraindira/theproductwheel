---
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import { groupForCategory, prettyCategory } from "../lib/taxonomy";
import { getPostHeroImage } from "../lib/postImages";

const { post, taxonomy } = Astro.props as {
  post: CollectionEntry<"posts">;
  taxonomy: any;
};

const FALLBACK_HERO = "/images/placeholder-hero.webp";

function formatDate(d: Date) {
  try {
    return new Date(d).toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "long",
      year: "numeric",
    });
  } catch {
    return "";
  }
}

const g = groupForCategory(taxonomy, post.data.category);

// Normalize hero image value
const heroImageRaw =
  typeof post?.data?.heroImage === "string" && post.data.heroImage.trim().length > 0
    ? post.data.heroImage.trim()
    : FALLBACK_HERO;

const isPublicHero = heroImageRaw.startsWith("/");
const heroAsset = !isPublicHero ? getPostHeroImage(heroImageRaw) : null;

const safeHeroAlt =
  (typeof post?.data?.heroAlt === "string" && post.data.heroAlt.trim().length > 0)
    ? post.data.heroAlt.trim()
    : post?.data?.title ?? "";
---

<a href={`/posts/${post.slug}`} class="block">
  <div class="overflow-hidden rounded-3xl border border-gray-200 bg-white shadow-sm">
    {isPublicHero ? (
      <img
        src={heroImageRaw}
        alt={safeHeroAlt}
        class="h-[280px] w-full object-cover sm:h-[320px]"
        loading="eager"
        decoding="async"
      />
    ) : heroAsset ? (
      <Image
        src={heroAsset}
        alt={safeHeroAlt}
        width={heroAsset.width}
        height={heroAsset.height}
        class="h-[280px] w-full object-cover sm:h-[320px]"
        sizes="(min-width: 1024px) 900px, 100vw"
        loading="eager"
        decoding="async"
      />
    ) : (
      <img
        src={FALLBACK_HERO}
        alt={safeHeroAlt}
        class="h-[280px] w-full object-cover sm:h-[320px]"
        loading="eager"
        decoding="async"
      />
    )}
  </div>

  <div class="mt-6">
    <div class="flex items-center justify-between gap-6">
      <div class="text-xs text-gray-500">
        {formatDate(post.data.publishedAt)}
        {" · "}
        {prettyCategory(post.data.category)}
      </div>

      <span class="inline-flex items-center rounded-full border border-gray-200 bg-gray-50 px-3 py-1 text-xs font-semibold text-gray-800">
        {g.label}
      </span>
    </div>

    <h1 class="mt-4 text-4xl sm:text-5xl font-semibold tracking-tight leading-[1.06] text-gray-900 hover:text-blue-800 transition">
      {post.data.title}
    </h1>

    {post.data.description ? (
      <p class="mt-4 text-base sm:text-lg text-gray-700 leading-relaxed max-w-none">
        {post.data.description}
      </p>
    ) : null}

    <div class="mt-5 text-sm font-semibold text-blue-700 hover:text-blue-800">
      Read the guide →
    </div>
  </div>
</a>
