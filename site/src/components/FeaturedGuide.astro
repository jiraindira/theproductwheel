---
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import { groupForCategory, categoryLabel } from "../lib/taxonomy";
import { getPostHeroImage } from "../lib/postImages";
import { normalizePostCategories, primaryCategory } from "../lib/normalizeCategories";

const { post, taxonomy } = Astro.props as {
  post: CollectionEntry<"posts">;
  taxonomy: any;
};

const FALLBACK_HERO = "/images/placeholder-hero.webp";

function formatDate(d: Date) {
  try {
    return new Date(d).toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "long",
      year: "numeric",
    });
  } catch {
    return "";
  }
}

// ✅ Canonical categories (works for both legacy + new)
const categories = normalizePostCategories(post, taxonomy);
const primary = primaryCategory(post, taxonomy);
const g = groupForCategory(taxonomy, primary);

// Prefer a homepage crop if present
const heroImageRaw = (() => {
  const preferred =
    typeof post?.data?.heroImageHome === "string" && post.data.heroImageHome.trim().length > 0
      ? post.data.heroImageHome.trim()
      : null;

  const fallback =
    typeof post?.data?.heroImage === "string" && post.data.heroImage.trim().length > 0
      ? post.data.heroImage.trim()
      : null;

  return preferred || fallback || FALLBACK_HERO;
})();

const isPublicHero = heroImageRaw.startsWith("/");
const heroAsset = !isPublicHero ? getPostHeroImage(heroImageRaw) : null;

const safeHeroAlt =
  typeof post?.data?.heroAlt === "string" && post.data.heroAlt.trim().length > 0
    ? post.data.heroAlt.trim()
    : post?.data?.title ?? "";

// Render up to 2 category labels, then +N
const metaCats = categories.slice(0, 2);
const extraCount = categories.length > 2 ? categories.length - 2 : 0;

// Hero styling: match our generated hero aspect (16:9) for cleaner crops
const HERO_CLASS = "w-full aspect-video object-cover bg-gray-50";
---

<a href={`/posts/${post.slug}`} class="block">
  <div class="overflow-hidden rounded-3xl border border-gray-200 bg-white shadow-sm">
    {isPublicHero ? (
      <img src={heroImageRaw} alt={safeHeroAlt} class={HERO_CLASS} loading="eager" decoding="async" />
    ) : heroAsset ? (
      <Image
        src={heroAsset}
        alt={safeHeroAlt}
        width={heroAsset.width}
        height={heroAsset.height}
        class={HERO_CLASS}
        sizes="(min-width: 1024px) 900px, 100vw"
        loading="eager"
        decoding="async"
      />
    ) : null}

    <div class="p-7 sm:p-8">
      <div class="flex flex-wrap items-center gap-2">
        {g ? (
          <span class="inline-flex items-center rounded-full bg-gray-900 px-3 py-1 text-xs font-semibold text-white">
            {g.label}
          </span>
        ) : null}

        {metaCats.map((c) => (
          <span class="inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1 text-xs font-semibold text-gray-900">
            {categoryLabel(taxonomy, c) || c}
          </span>
        ))}

        {extraCount > 0 ? (
          <span class="inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1 text-xs font-semibold text-gray-700">
            +{extraCount}
          </span>
        ) : null}
      </div>

      <h2 class="mt-4 text-3xl font-semibold tracking-tight text-gray-900 sm:text-4xl">
        {post.data.title}
      </h2>

      {post.data.description ? (
        <p class="mt-3 text-base leading-relaxed text-gray-700 sm:text-lg">
          {post.data.description}
        </p>
      ) : null}

      <div class="mt-5 flex items-center justify-between gap-6 text-sm text-gray-600">
        <span class="font-semibold text-gray-900">Read guide →</span>
        <span>{formatDate(post.data.publishedAt)}</span>
      </div>
    </div>
  </div>
</a>
