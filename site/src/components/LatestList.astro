---
import type { CollectionEntry } from "astro:content";

const { posts = [], title = "The latest", viewAllHref = "/posts" } = Astro.props as {
  posts: CollectionEntry<"posts">[];
  title?: string;
  viewAllHref?: string;
};

function formatDate(d: Date) {
  try {
    return new Date(d).toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "long",
      year: "numeric",
    });
  } catch {
    return "";
  }
}

function normalizeCategoryId(x: unknown) {
  return String(x || "").trim().toLowerCase();
}

function prettyCategory(s: string) {
  if (!s) return "";
  return s
    .replace(/_/g, " ")
    .replace(/-/g, " ")
    .replace(/\b\w/g, (c) => c.toUpperCase())
    .replace(/\bAnd\b/g, "&");
}

function getPostCategories(post: CollectionEntry<"posts">): string[] {
  const d: any = post?.data ?? {};
  if (Array.isArray(d.categories)) {
    return d.categories.map(normalizeCategoryId).filter(Boolean);
  }
  const legacy = normalizeCategoryId(d.category);
  return legacy ? [legacy] : [];
}
---

<div data-component="LatestList">
  <div class="flex items-end justify-between">
    <h2 class="text-base font-bold tracking-tight text-gray-900">{title}</h2>
    <a href={viewAllHref} class="text-sm font-semibold text-blue-700 hover:text-blue-800">
      View all â†’
    </a>
  </div>

  <hr class="mt-4 border-t-2 border-gray-900/25" />

  <div class="mt-6 space-y-6">
    {posts.slice(0, 6).map((post) => {
      const cats = getPostCategories(post);

      return (
        <a href={`/posts/${post.slug}`} class="block group">
          <div class="text-xs text-gray-500">{formatDate(post.data.publishedAt)}</div>

          <div class="mt-2 text-base font-semibold leading-snug text-gray-900 group-hover:text-blue-800">
            {post.data.title}
          </div>

          {cats.length > 0 ? (
            <div class="mt-2 flex flex-wrap gap-2">
              {cats.slice(0, 2).map((c) => (
                <span class="cat-pill">{prettyCategory(c)}</span>
              ))}
              {cats.length > 2 ? <span class="cat-pill cat-pill-muted">+{cats.length - 2}</span> : null}
            </div>
          ) : null}
        </a>
      );
    })}
  </div>
</div>

<style>
  .cat-pill {
    display: inline-flex;
    align-items: center;
    font-size: 11px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(17, 24, 39, 0.12);
    background: rgba(17, 24, 39, 0.03);
    color: rgba(17, 24, 39, 0.75);
  }

  .cat-pill-muted {
    background: rgba(17, 24, 39, 0.02);
    color: rgba(55, 65, 81, 0.65);
  }
</style>
