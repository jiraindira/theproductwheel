---
import SiteLayout from "../../layouts/SiteLayout.astro";
import GuideCard from "../../components/GuideCard.astro";
import { getCollection } from "astro:content";
import { getTaxonomy, resolveCategoryId, categoryLabel, normalizePostCategories } from "../../lib/taxonomy";
import {
  buildBreadcrumbList,
  buildCollectionPageJsonLd,
  toAbsoluteUrl,
} from "../../lib/structuredData";

export async function getStaticPaths() {
  const taxonomy = await getTaxonomy();
  return taxonomy.categories.map((c) => ({
    params: { category: c.id },
    props: { categoryId: c.id },
  }));
}

const taxonomy = await getTaxonomy();
const { category: rawCategory } = Astro.params;

// Normalize route param to a real category id (supports aliases)
const categoryId = resolveCategoryId(taxonomy, rawCategory);
const label = categoryLabel(taxonomy, categoryId);

const posts = await getCollection("posts");
posts.sort((a, b) => {
  const t = b.data.publishedAt.getTime() - a.data.publishedAt.getTime();
  if (t !== 0) return t;
  return b.slug.localeCompare(a.slug);
});

const filtered = posts.filter((p) => {
  const cats = normalizePostCategories(taxonomy, p.data);
  return cats.includes(categoryId);
});

const title = `${label} buying guides`;
const description = `Latest curated picks in ${label}.`;

const baseUrl = (Astro.site ?? "http://localhost").toString();
const canonicalPath = `/category/${categoryId}`;
const canonicalUrl = toAbsoluteUrl(baseUrl, canonicalPath);

const breadcrumbJsonLd = buildBreadcrumbList([
  { name: taxonomy.brand.name, url: toAbsoluteUrl(baseUrl, "/") },
  { name: "Guides", url: toAbsoluteUrl(baseUrl, "/posts") },
  { name: label, url: canonicalUrl },
]);

const listJsonLd = buildCollectionPageJsonLd({
  canonicalUrl,
  name: title,
  description,
  itemList: filtered.map((p) => ({
    name: String(p.data.title),
    url: toAbsoluteUrl(baseUrl, `/posts/${p.slug}`),
  })),
});
---

<SiteLayout title={title} description={description} canonical={`/category/${categoryId}`}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(listJsonLd)} />
  </Fragment>

  <div class="max-w-6xl mx-auto px-6 pt-12">
    <div class="flex items-end justify-between gap-6">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight text-gray-900">{label}</h1>
        <p class="mt-2 text-sm text-gray-600">
          {description}
        </p>
      </div>

      <a href="/posts" class="text-sm font-semibold text-blue-700 hover:text-blue-800">
        View all â†’
      </a>
    </div>

    <hr class="mt-6 border-t-2 border-gray-900/25" />

    {filtered.length ? (
      <div class="mt-10 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {filtered.map((post) => {
          const cats = normalizePostCategories(taxonomy, post.data);
          const primary = cats[0] ?? "";

          return (
            <GuideCard
              href={`/posts/${post.slug}`}
              title={post.data.title}
              description={post.data.description}
              category={primary}
              categories={cats}
              publishedAt={post.data.publishedAt}
              products={post.data.products}
              heroImage={post.data.heroImageCard ?? post.data.heroImage}
              heroAlt={post.data.heroAlt}
            />
          );
        })}
      </div>
    ) : (
      <div class="mt-10 rounded-2xl border border-dashed border-gray-300 bg-white p-10">
        <p class="text-sm text-gray-600">No guides in this category yet.</p>
      </div>
    )}
  </div>
</SiteLayout>
