---
import { getCollection } from "astro:content";
import SiteLayout from "../../layouts/SiteLayout.astro";
import TopTopicsNav from "../../components/TopTopicsNav.astro";
import GuideCard from "../../components/GuideCard.astro";
import { getTaxonomy } from "../../lib/taxonomy";

const taxonomy = await getTaxonomy();

const posts = await getCollection("posts");
posts.sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime());

const countsByGroup = taxonomy.groups.reduce((acc, g) => {
  acc[g.key] = posts.filter((p) => g.categories.includes(p.data.category)).length;
  return acc;
}, /** @type {Record<string, number>} */ ({}));

const navItems = [
  { key: "all", label: "All", count: posts.length, href: "/posts" },
  ...taxonomy.groups.map((g) => ({
    key: g.key,
    label: g.label,
    count: countsByGroup[g.key] ?? 0,
    href: `/posts/${g.key}`,
  })),
];

const seoTitle = `Buying Guides | ${taxonomy.brand.name}`;
const seoDescription = `Browse ${taxonomy.brand.name} buying guides.`;
---

<SiteLayout title={seoTitle} description={seoDescription} canonical="/posts">
  <div class="max-w-6xl mx-auto px-6 pt-8 pb-16">
    <header class="max-w-3xl">
      <h1 class="text-4xl sm:text-5xl font-semibold text-gray-900 leading-[1.12] tracking-[-0.015em]">
        All buying guides
      </h1>
      <p class="mt-4 text-base sm:text-lg text-gray-700 leading-relaxed">
        Browse <span class="font-semibold text-gray-900">{posts.length}</span> guides.
      </p>
    </header>

    <TopTopicsNav items={navItems} active="all" />

    <div class="mt-10 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {posts.map((post) => (
        <GuideCard
          href={`/posts/${post.slug}`}
          title={post.data.title}
          description={post.data.description}
          category={post.data.category}
          publishedAt={post.data.publishedAt}
          products={post.data.products}
          heroImage={post.data.heroImage}
          heroAlt={post.data.heroAlt}
        />
      ))}
    </div>
  </div>
</SiteLayout>
