---
import SiteLayout from "../../layouts/SiteLayout.astro";
import HomePostCard from "../../components/HomePostCard.astro";
import { getCollection } from "astro:content";
import { getTaxonomy } from "../../lib/taxonomy";
import { normalizePostCategories } from "../../lib/normalizeCategories";
import { categoryLabel } from "../../lib/taxonomy";
import { getPostCardDescription } from "../../lib/postExcerpt";
import {
  buildBreadcrumbList,
  buildCollectionPageJsonLd,
  toAbsoluteUrl,
} from "../../lib/structuredData";

export async function getStaticPaths() {
  const taxonomy = await getTaxonomy();

  // Build routes from taxonomy groups (plus "all")
  const paths = [
    { params: { group: "all" } },
    ...taxonomy.groups.map((g) => ({ params: { group: g.key } })),
  ];

  // De-dupe group keys
  const seen = new Set<string>();
  return paths.filter((p) => {
    const k = String(p.params.group || "").trim().toLowerCase();
    if (!k || seen.has(k)) return false;
    seen.add(k);
    return true;
  });
}

const taxonomy = await getTaxonomy();
const { group } = Astro.params;

const groupKey = String(group || "").trim().toLowerCase();

// Find group (except "all")
const grp =
  groupKey === "all"
    ? { key: "all", label: "All", intro: "", categoryIds: [] as string[] }
    : taxonomy.groups.find((g) => String(g.key || "").trim().toLowerCase() === groupKey);

const label = grp?.label ?? "All";
const intro = grp?.intro ?? "";

// ✅ taxonomy.json uses groups[].categoryIds
const groupCats =
  groupKey === "all"
    ? null
    : (grp?.categoryIds ?? (grp as any)?.categories ?? [])
        .map((c) => String(c || "").trim().toLowerCase())
        .filter(Boolean);

const posts = await getCollection("posts");
posts.sort((a, b) => {
  const t = b.data.publishedAt.getTime() - a.data.publishedAt.getTime();
  if (t !== 0) return t;
  return b.slug.localeCompare(a.slug);
});

// Include if ANY category matches
const filtered =
  groupKey === "all"
    ? posts
    : posts.filter((post) => {
        const postCats = normalizePostCategories(post, taxonomy);
        return postCats.some((c) => (groupCats ?? []).includes(c));
      });

const filterCategories = (() => {
  const seen = new Set<string>();
  const derived: Array<{ id: string; label: string }> = [];

  for (const p of filtered) {
    for (const c of normalizePostCategories(p, taxonomy)) {
      if (!c || seen.has(c)) continue;
      seen.add(c);
      derived.push({ id: c, label: categoryLabel(taxonomy, c) });
    }
  }

  return derived.sort((a, b) => a.label.localeCompare(b.label));
})();

const countsByCategory: Record<string, number> = {};
for (const c of filterCategories) {
  countsByCategory[c.id] = filtered.filter((post) => normalizePostCategories(post, taxonomy).includes(c.id)).length;
}

const pageTitle = `${label} guides`;
const seoDesc = intro || `Latest curated buying guides in ${label}.`;
const displayDesc = intro;

const baseUrl = (Astro.site ?? "http://localhost").toString();
const canonicalPath = `/posts/${groupKey}`;
const canonicalUrl = toAbsoluteUrl(baseUrl, canonicalPath);

const breadcrumbJsonLd = buildBreadcrumbList([
  { name: taxonomy.brand.name, url: toAbsoluteUrl(baseUrl, "/") },
  { name: "Guides", url: toAbsoluteUrl(baseUrl, "/posts") },
  { name: label, url: canonicalUrl },
]);

const listJsonLd = buildCollectionPageJsonLd({
  canonicalUrl,
  name: pageTitle,
  description: seoDesc,
  itemList: filtered.map((p) => ({
    name: String(p.data.title),
    url: toAbsoluteUrl(baseUrl, `/posts/${p.slug}`),
  })),
});
---

<SiteLayout title={pageTitle} description={seoDesc} canonical={`/posts/${groupKey}`}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(listJsonLd)} />
  </Fragment>

  <div class="max-w-6xl mx-auto px-6 pt-6">
    <header class="mt-2">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <div class="flex items-baseline gap-2">
            <h1 class="text-3xl font-semibold tracking-tight text-gray-900 sm:text-4xl">{label}</h1>
            <span id="guide-count" class="text-sm font-semibold text-gray-500 sm:text-base">({filtered.length})</span>
          </div>
          {displayDesc ? <p class="mt-2 text-sm text-gray-600">{displayDesc}</p> : null}
          <a href="/posts" class="mt-2 inline-flex text-sm font-semibold text-blue-700 hover:text-blue-800 sm:hidden">
            View all
          </a>
        </div>

        <div class="flex w-full items-center gap-2 sm:w-auto">
          <div class="min-w-0 flex-1 sm:flex-none sm:w-80">
            <label for="guide-search" class="sr-only">Search guides</label>
            <input
              id="guide-search"
              type="search"
              inputmode="search"
              autocomplete="off"
              placeholder="Search guides…"
              class="w-full min-w-0 rounded-2xl border border-gray-200 bg-white px-4 py-3 text-sm text-gray-900 shadow-sm outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-100"
            />
          </div>

          <button
            id="guide-filter-open"
            type="button"
            class="relative inline-flex h-[46px] w-[46px] items-center justify-center rounded-2xl border border-gray-200 bg-white text-gray-900 shadow-sm hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2"
            aria-label="Filter guides"
            aria-haspopup="dialog"
            aria-expanded="false"
            aria-controls="guide-filter-drawer"
          >
            <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M4 6h16" />
              <path d="M7 12h10" />
              <path d="M10 18h4" />
            </svg>
            <span
              id="guide-filter-badge"
              class="pointer-events-none absolute -right-1 -top-1 hidden h-5 min-w-5 items-center justify-center rounded-full bg-gray-900 px-1 text-[11px] font-semibold text-white"
            ></span>
          </button>
        </div>
      </div>
    </header>

    <div id="guide-active-filters" class="mt-3 flex flex-wrap gap-2"></div>

    <p id="guide-status" class="sr-only" aria-live="polite"></p>

    <div class="mt-4 hidden sm:block">
      <a href="/posts" class="text-sm font-semibold text-blue-700 hover:text-blue-800">View all</a>
    </div>

    {filtered.length ? (
      <div class="mt-10 grid grid-cols-2 gap-3 sm:gap-4 md:grid-cols-3 lg:grid-cols-4">
        {filtered.map((post) => {
          const cats = normalizePostCategories(post, taxonomy);
          const cardDescription = getPostCardDescription(post);
          const haystack = [post.data.title, cardDescription, cats.join(" ")]
            .filter(Boolean)
            .join(" ")
            .toLowerCase();

          return (
            <div data-guide data-search={haystack} data-cats={cats.join(",")}>
              <HomePostCard post={post} />
            </div>
          );
        })}
      </div>
    ) : (
      <div class="mt-10 rounded-2xl border border-dashed border-gray-300 bg-white p-10">
        <p class="text-sm text-gray-600">No guides in this section yet.</p>
      </div>
    )}
  </div>
</SiteLayout>

<div
  id="guide-filter-backdrop"
  class="fixed inset-0 z-40 bg-black/30 opacity-0 pointer-events-none transition-opacity"
  aria-hidden="true"
></div>

<aside
  id="guide-filter-drawer"
  class="fixed inset-y-0 right-0 z-50 w-[min(92vw,22rem)] translate-x-full border-l border-gray-200 bg-white shadow-xl transition-transform"
  role="dialog"
  aria-modal="true"
  aria-label="Filter guides"
>
  <div class="flex h-full flex-col">
    <div class="flex items-center justify-between border-b border-gray-200 px-5 py-4">
      <div>
        <div class="text-sm font-semibold text-gray-900">Filters</div>
        <div class="mt-0.5 text-xs text-gray-600">Choose categories to narrow results.</div>
      </div>

      <button
        id="guide-filter-close"
        type="button"
        class="inline-flex h-10 w-10 items-center justify-center rounded-2xl border border-gray-200 bg-white text-gray-900 hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2"
        aria-label="Close filters"
      >
        <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M18 6L6 18" />
          <path d="M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="flex-1 overflow-auto px-5 py-4">
      <fieldset>
        <legend class="text-sm font-semibold text-gray-900">Categories</legend>
        <div class="mt-4 space-y-3">
          {filterCategories
            .filter((c) => (countsByCategory[c.id] ?? 0) > 0)
            .map((c) => (
              <label class="flex cursor-pointer items-center justify-between gap-3 rounded-2xl border border-gray-200 bg-white px-4 py-3 hover:bg-gray-50">
                <span class="flex items-center gap-3">
                  <input
                    type="checkbox"
                    class="h-4 w-4 rounded border-gray-300 text-gray-900 focus:ring-gray-900"
                    name="categories"
                    value={c.id}
                  />
                  <span class="text-sm font-semibold text-gray-900">{c.label}</span>
                </span>
                <span class="text-xs font-semibold text-gray-600">{countsByCategory[c.id] ?? 0}</span>
              </label>
            ))}
        </div>
      </fieldset>
    </div>

    <div class="border-t border-gray-200 p-5">
      <div class="flex items-center gap-3">
        <button
          id="guide-filter-clear"
          type="button"
          class="inline-flex w-1/2 items-center justify-center rounded-2xl border border-gray-200 bg-white px-4 py-3 text-sm font-semibold text-gray-900 hover:bg-gray-50"
        >
          Clear
        </button>
        <button
          id="guide-filter-done"
          type="button"
          class="inline-flex w-1/2 items-center justify-center rounded-2xl bg-gray-900 px-4 py-3 text-sm font-semibold text-white hover:bg-gray-800"
        >
          Done
        </button>
      </div>
    </div>
  </div>
</aside>

<script>
  (() => {
    const input = document.getElementById("guide-search");
    const status = document.getElementById("guide-status");
    const countEl = document.getElementById("guide-count");
    const chipsEl = document.getElementById("guide-active-filters");
    const openBtn = document.getElementById("guide-filter-open");
    const badge = document.getElementById("guide-filter-badge");
    const drawer = document.getElementById("guide-filter-drawer");
    const backdrop = document.getElementById("guide-filter-backdrop");
    const closeBtn = document.getElementById("guide-filter-close");
    const doneBtn = document.getElementById("guide-filter-done");
    const clearBtn = document.getElementById("guide-filter-clear");
    const cards = Array.from(document.querySelectorAll("[data-guide]"));

    if (
      !(input instanceof HTMLInputElement) ||
      !status ||
      !(countEl instanceof HTMLElement) ||
      !(chipsEl instanceof HTMLElement) ||
      !(openBtn instanceof HTMLButtonElement) ||
      !(drawer instanceof HTMLElement) ||
      !(backdrop instanceof HTMLElement) ||
      !(closeBtn instanceof HTMLButtonElement) ||
      !(doneBtn instanceof HTMLButtonElement) ||
      !(clearBtn instanceof HTMLButtonElement)
    ) {
      return;
    }

    const checkboxes = Array.from(
      drawer.querySelectorAll('input[type="checkbox"][name="categories"]')
    ).filter((el) => el instanceof HTMLInputElement);

    const params = new URLSearchParams(window.location.search);
    const category = (params.get("category") || "").trim().toLowerCase();
    const categoriesRaw = (params.get("categories") || "").trim().toLowerCase();
    const q0 = (params.get("q") || "").trim();

    const selected = new Set(
      (categoriesRaw ? categoriesRaw.split(",") : category ? [category] : [])
        .map((s) => s.trim().toLowerCase())
        .filter(Boolean)
    );

    if (q0) input.value = q0;

    for (const cb of checkboxes) {
      cb.checked = selected.has(cb.value.trim().toLowerCase());
    }

    function renderChips() {
      chipsEl.innerHTML = "";

      if (selected.size === 0) {
        chipsEl.classList.add("hidden");
        return;
      }

      chipsEl.classList.remove("hidden");

      for (const id of Array.from(selected)) {
        const label =
          checkboxes.find((cb) => cb.value.trim().toLowerCase() === id)?.closest("label")?.querySelector("span.text-sm")
            ?.textContent || id;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className =
          "inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white px-3 py-1.5 text-sm font-semibold text-gray-900 shadow-sm hover:bg-gray-50";
        btn.setAttribute("data-chip", id);
        btn.setAttribute("aria-label", `Remove ${label} filter`);
        btn.innerHTML = `${label}<span aria-hidden=\"true\" class=\"text-gray-500\">×</span>`;
        btn.addEventListener("click", () => {
          selected.delete(id);
          for (const cb of checkboxes) {
            if (cb.value.trim().toLowerCase() === id) cb.checked = false;
          }
          apply({ updateUrl: true });
        });

        chipsEl.appendChild(btn);
      }

      const clearAll = document.createElement("button");
      clearAll.type = "button";
      clearAll.className =
        "inline-flex items-center rounded-full bg-gray-900 px-3 py-1.5 text-sm font-semibold text-white hover:bg-gray-800";
      clearAll.textContent = "Clear all";
      clearAll.addEventListener("click", () => {
        selected.clear();
        for (const cb of checkboxes) cb.checked = false;
        apply({ updateUrl: true });
      });
      chipsEl.appendChild(clearAll);
    }

    let drawerOpen = false;
    let previouslyFocused = null;

    function getFocusableInDrawer() {
      return Array.from(
        drawer.querySelectorAll(
          'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
        )
      ).filter((el) => el instanceof HTMLElement && !el.hasAttribute("disabled"));
    }

    function setDrawerOpen(next) {
      const open = Boolean(next);
      drawerOpen = open;
      openBtn.setAttribute("aria-expanded", open ? "true" : "false");
      drawer.classList.toggle("translate-x-full", !open);
      backdrop.classList.toggle("pointer-events-none", !open);
      backdrop.classList.toggle("opacity-0", !open);

      if (open) {
        previouslyFocused = document.activeElement;
        document.body.style.overflow = "hidden";
      } else {
        document.body.style.overflow = "";
      }

      if (open) {
        closeBtn.focus();
      } else {
        if (previouslyFocused instanceof HTMLElement) previouslyFocused.focus();
        else openBtn.focus();
      }
    }

    function syncBadge() {
      const n = selected.size;
      if (!(badge instanceof HTMLElement)) return;
      if (n <= 0) {
        badge.classList.add("hidden");
        badge.textContent = "";
        return;
      }
      badge.classList.remove("hidden");
      badge.textContent = String(n);
    }

    function apply({ updateUrl } = { updateUrl: true }) {
      const q = input.value.trim().toLowerCase();
      let shown = 0;

      for (const el of cards) {
        const hay = (el.getAttribute("data-search") || "").toLowerCase();
        const cats = (el.getAttribute("data-cats") || "")
          .split(",")
          .map((s) => s.trim().toLowerCase())
          .filter(Boolean);

        const okCats = selected.size === 0 || cats.some((c) => selected.has(c));
        const okQ = !q || hay.includes(q);
        const show = okQ && okCats;

        el.style.display = show ? "" : "none";
        if (show) shown++;
      }

      const parts = [];
      if (selected.size) parts.push(`Categories: ${Array.from(selected).join(", ")}`);
      if (q) parts.push(`Search: “${q}”`);

      countEl.textContent = `(${shown})`;
      status.textContent = parts.length
        ? `Showing ${shown} guides. ${parts.join(" · ")}`
        : `Showing ${shown} guides.`;

      if (updateUrl) {
        const next = new URLSearchParams(window.location.search);
        if (q) next.set("q", q);
        else next.delete("q");

        if (selected.size) {
          next.set("categories", Array.from(selected).join(","));
          next.delete("category");
        } else {
          next.delete("categories");
          next.delete("category");
        }

        const qs = next.toString();
        const url = qs ? `${window.location.pathname}?${qs}` : window.location.pathname;
        window.history.replaceState({}, "", url);
      }

      syncBadge();
      renderChips();
    }

    input.addEventListener("input", () => apply({ updateUrl: true }));

    openBtn.addEventListener("click", () => setDrawerOpen(true));
    closeBtn.addEventListener("click", () => setDrawerOpen(false));
    doneBtn.addEventListener("click", () => setDrawerOpen(false));
    backdrop.addEventListener("click", () => setDrawerOpen(false));

    clearBtn.addEventListener("click", () => {
      selected.clear();
      for (const cb of checkboxes) cb.checked = false;
      apply({ updateUrl: true });
    });

    for (const cb of checkboxes) {
      cb.addEventListener("change", () => {
        const id = cb.value.trim().toLowerCase();
        if (!id) return;
        if (cb.checked) selected.add(id);
        else selected.delete(id);
        apply({ updateUrl: true });
      });
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setDrawerOpen(false);

      if (drawerOpen && e.key === "Tab") {
        const focusables = getFocusableInDrawer();
        if (focusables.length === 0) return;

        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        const active = document.activeElement;

        if (e.shiftKey) {
          if (active === first || !drawer.contains(active)) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if (active === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
    });

    apply({ updateUrl: false });
  })();
</script>